<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Anonymous Chatrooms</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #000;
      color: #fff;
    }

    @keyframes glow {
      0%, 100% { filter: drop-shadow(0 0 5px rgba(255, 255, 255, 0.5)); }
      50% { filter: drop-shadow(0 0 15px rgba(255, 255, 255, 0.8)); }
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.8; transform: scale(1.05); }
    }

    @keyframes ring {
      0%, 100% { transform: scale(1) rotate(0deg); }
      10%, 30% { transform: scale(1.1) rotate(-10deg); }
      20%, 40% { transform: scale(1.1) rotate(10deg); }
      50% { transform: scale(1) rotate(0deg); }
    }

    .glow {
      animation: glow 2s ease-in-out infinite;
    }

    .glow-text {
      text-shadow: 0 0 10px rgba(255, 255, 255, 0.8), 0 0 20px rgba(255, 255, 255, 0.4);
    }

    .glow-border {
      box-shadow: 0 0 15px rgba(255, 255, 255, 0.3), inset 0 0 15px rgba(255, 255, 255, 0.1);
    }

    .glow-button {
      box-shadow: 0 0 20px rgba(255, 255, 255, 0.4);
      transition: all 0.3s ease;
    }

    .glow-button:hover {
      box-shadow: 0 0 30px rgba(255, 255, 255, 0.7);
      background: #fff !important;
      color: #000 !important;
    }

    input:focus, textarea:focus {
      outline: none;
      box-shadow: 0 0 20px rgba(255, 255, 255, 0.5);
    }

    .message-bubble {
      transition: all 0.3s ease;
      position: relative;
    }

    .message-bubble:hover {
      transform: translateY(-2px);
    }

    .message-bubble:hover .message-actions {
      opacity: 1;
      pointer-events: auto;
    }

    .message-actions {
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s;
      position: absolute;
      top: -5px;
      right: 5px;
      display: flex;
      gap: 5px;
      z-index: 10;
    }

    .action-btn {
      background: rgba(0, 0, 0, 0.9);
      border: 1px solid rgba(255, 255, 255, 0.3);
      padding: 6px 10px;
      border-radius: 8px;
      cursor: pointer;
      color: #fff;
      font-size: 14px;
      transition: all 0.2s;
      backdrop-filter: blur(10px);
    }

    .action-btn:hover {
      background: rgba(255, 255, 255, 0.3);
      border-color: #fff;
      transform: scale(1.1);
    }

    .emoji-picker {
      position: absolute;
      bottom: 100%;
      right: 0;
      background: #1a1a1a;
      border: 1px solid #333;
      border-radius: 10px;
      padding: 10px;
      display: grid;
      grid-template-columns: repeat(6, 1fr);
      gap: 5px;
      margin-bottom: 5px;
      box-shadow: 0 -5px 20px rgba(0, 0, 0, 0.5);
      z-index: 1000;
    }

    .emoji-btn {
      background: transparent;
      border: none;
      font-size: 24px;
      cursor: pointer;
      padding: 5px;
      border-radius: 5px;
      transition: all 0.2s;
    }

    .emoji-btn:hover {
      background: #2a2a2a;
      transform: scale(1.2);
    }

    .reaction-container {
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
      margin-top: 8px;
    }

    .reaction {
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 12px;
      padding: 4px 10px;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 4px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .reaction:hover {
      background: rgba(255, 255, 255, 0.2);
      transform: scale(1.05);
    }

    .reaction.active {
      background: rgba(255, 255, 255, 0.3);
      border-color: #fff;
      font-weight: bold;
    }

    .typing-indicator {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid #333;
      border-radius: 10px;
      padding: 10px 15px;
      margin-bottom: 10px;
      font-size: 13px;
      color: #999;
      font-style: italic;
    }

    .system-message {
      text-align: center;
      color: #666;
      font-size: 13px;
      font-style: italic;
      padding: 8px;
      margin: 10px 0;
      background: rgba(255, 255, 255, 0.02);
      border-radius: 8px;
    }

    .video-call-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.98);
      z-index: 10000;
      display: flex;
      flex-direction: column;
    }

    .video-container {
      flex: 1;
      display: flex;
      justify-content: center;
      align-items: center;
      position: relative;
      padding: 20px;
    }

    .remote-video {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: 20px;
      background: #000;
      box-shadow: 0 0 50px rgba(0, 0, 0, 0.8);
    }

    .local-video {
      position: absolute;
      bottom: 80px;
      right: 20px;
      width: 180px;
      height: 240px;
      object-fit: cover;
      border-radius: 15px;
      border: 3px solid rgba(255, 255, 255, 0.2);
      background: #1a1a1a;
      box-shadow: 0 5px 20px rgba(0, 0, 0, 0.5);
    }

    .call-status {
      text-align: center;
      color: #fff;
    }

    .call-controls {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 20px;
      padding: 15px 30px;
      background: rgba(0, 0, 0, 0.6);
      border-radius: 50px;
      backdrop-filter: blur(10px);
    }

    .call-btn {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      border: none;
      font-size: 24px;
      cursor: pointer;
      transition: all 0.3s;
      background: rgba(255, 255, 255, 0.1);
      color: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .call-btn:hover {
      background: rgba(255, 255, 255, 0.2);
      transform: scale(1.1);
    }

    .call-btn.active {
      background: rgba(255, 50, 50, 0.8);
    }

    .call-btn.end {
      background: #ff3b30;
    }

    .call-btn.end:hover {
      background: #ff1a1a;
    }

    .incoming-call {
      background: #1a1a1a;
      border: 1px solid #333;
      border-radius: 20px;
      padding: 40px;
      text-align: center;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
    }

    .ringing-icon {
      animation: ring 2s ease-in-out infinite;
    }

    .calling-status {
      animation: pulse 2s ease-in-out infinite;
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyCHGTZHNPdjfb-cGGXJMevlvDtgXyPygFA",
      authDomain: "chatroom-b5e53.firebaseapp.com",
      databaseURL: "https://chatroom-b5e53-default-rtdb.firebaseio.com",
      projectId: "chatroom-b5e53",
      storageBucket: "chatroom-b5e53.firebasestorage.app",
      messagingSenderId: "1083699838126",
      appId: "1:1083699838126:web:6eacf8da63b1e64b6cb3a1",
      measurementId: "G-MRGR2PJJK3"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    // Icons
    const Send = () => <span>‚û§</span>;
    const Phone = () => <span>üìû</span>;
    const Bug = () => <span>üêõ</span>;

    // Debug Console Component
    function DebugConsole({ logs, onClose }) {
      return (
        <div style={{ position: 'fixed', bottom: 0, right: 0, width: '400px', height: '300px', background: '#1a1a1a', border: '1px solid #333', borderRadius: '10px 10px 0 0', zIndex: 10002, display: 'flex', flexDirection: 'column' }}>
          <div style={{ padding: '10px', borderBottom: '1px solid #333', display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
            <div style={{ fontWeight: 'bold', fontSize: '14px' }}>üêõ Debug Console</div>
            <button onClick={onClose} style={{ background: 'transparent', border: 'none', color: '#999', cursor: 'pointer', fontSize: '20px' }}>√ó</button>
          </div>
          <div style={{ flex: 1, overflowY: 'auto', padding: '10px', fontSize: '11px', fontFamily: 'monospace' }}>
            {logs.map((log, i) => (
              <div key={i} style={{ marginBottom: '5px', color: log.type === 'error' ? '#ff6b6b' : log.type === 'warn' ? '#ffd93d' : '#6bcf7f' }}>
                <span style={{ color: '#999' }}>[{log.time}]</span> {log.message}
              </div>
            ))}
          </div>
        </div>
      );
    }

    // Minimized Window Component for Games
    function MinimizedWindow({ title, url, icon, onClose }) {
      const [isMaximized, setIsMaximized] = useState(false);
      
      return (
        <>
          {!isMaximized && (
            <div style={{ 
              position: 'fixed', 
              bottom: '20px', 
              left: '20px', 
              background: '#1a1a1a', 
              border: '1px solid #333', 
              borderRadius: '10px', 
              padding: '15px 20px',
              display: 'flex',
              gap: '15px',
              alignItems: 'center',
              zIndex: 9999,
              boxShadow: '0 5px 20px rgba(0,0,0,0.5)'
            }}>
              <span style={{ fontSize: '24px' }}>{icon}</span>
              <span style={{ fontWeight: 'bold' }}>{title}</span>
              <button 
                onClick={() => setIsMaximized(true)} 
                style={{ 
                  background: '#333', 
                  border: 'none', 
                  color: '#fff', 
                  padding: '8px 15px', 
                  borderRadius: '5px', 
                  cursor: 'pointer',
                  fontSize: '12px'
                }}
              >
                Open
              </button>
              <button 
                onClick={onClose} 
                style={{ 
                  background: '#ff3b30', 
                  border: 'none', 
                  color: '#fff', 
                  padding: '8px 15px', 
                  borderRadius: '5px', 
                  cursor: 'pointer',
                  fontSize: '12px'
                }}
              >
                Close
              </button>
            </div>
          )}
          
          {isMaximized && (
            <div style={{ 
              position: 'fixed', 
              top: 0, 
              left: 0, 
              right: 0, 
              bottom: 0, 
              background: '#000', 
              zIndex: 10000,
              display: 'flex',
              flexDirection: 'column'
            }}>
              <div style={{ 
                padding: '15px 20px', 
                background: '#1a1a1a', 
                borderBottom: '1px solid #333',
                display: 'flex',
                justifyContent: 'space-between',
                alignItems: 'center'
              }}>
                <div style={{ display: 'flex', gap: '10px', alignItems: 'center' }}>
                  <span style={{ fontSize: '24px' }}>{icon}</span>
                  <span style={{ fontWeight: 'bold' }}>{title}</span>
                </div>
                <div style={{ display: 'flex', gap: '10px' }}>
                  <button 
                    onClick={() => setIsMaximized(false)} 
                    style={{ 
                      background: '#333', 
                      border: 'none', 
                      color: '#fff', 
                      padding: '8px 15px', 
                      borderRadius: '5px', 
                      cursor: 'pointer'
                    }}
                  >
                    Minimize
                  </button>
                  <button 
                    onClick={onClose} 
                    style={{ 
                      background: '#ff3b30', 
                      border: 'none', 
                      color: '#fff', 
                      padding: '8px 15px', 
                      borderRadius: '5px', 
                      cursor: 'pointer'
                    }}
                  >
                    Close
                  </button>
                </div>
              </div>
              <iframe 
                src={url} 
                style={{ 
                  flex: 1, 
                  border: 'none', 
                  width: '100%' 
                }}
                allow="fullscreen"
              />
            </div>
          )}
        </>
      );
    }

    function ChatroomApp() {
      const [screen, setScreen] = useState('home');
      const [roomCode, setRoomCode] = useState('');
      const [username, setUsername] = useState('');
      const [currentRoom, setCurrentRoom] = useState(null);
      const [messages, setMessages] = useState([]);
      const [message, setMessage] = useState('');
      const [users, setUsers] = useState([]);
      const [logs, setLogs] = useState([]);
      const [showDebug, setShowDebug] = useState(false);
      const [showEmojiPicker, setShowEmojiPicker] = useState(null);
      const [reactions, setReactions] = useState({});
      const [typingUsers, setTypingUsers] = useState({});
      const [showCamera, setShowCamera] = useState(false);
      const [cameraReady, setCameraReady] = useState(false);
      const [showImageInput, setShowImageInput] = useState(false);
      const [imageUrl, setImageUrl] = useState('');
      const [openGameWindows, setOpenGameWindows] = useState([]);
      
      // Video call states
      const [inCall, setInCall] = useState(false);
      const [callWith, setCallWith] = useState(null);
      const [localStream, setLocalStream] = useState(null);
      const [remoteStream, setRemoteStream] = useState(null);
      const [peerConnection, setPeerConnection] = useState(null);
      const [isMuted, setIsMuted] = useState(false);
      const [isVideoOff, setIsVideoOff] = useState(false);
      const [incomingCall, setIncomingCall] = useState(null);
      const [isRinging, setIsRinging] = useState(false);

      const videoRef = useRef(null);
      const canvasRef = useRef(null);
      const localVideoRef = useRef(null);
      const remoteVideoRef = useRef(null);
      const messagesEndRef = useRef(null);
      const typingTimeoutRef = useRef(null);

      const emojis = ['üòÄ', 'üòÇ', 'üòç', 'üòé', 'ü§î', 'üò¢', 'üò°', 'üëç', 'üëé', '‚ù§Ô∏è', 'üî•', '‚ú®'];

      const addLog = (message, type = 'info') => {
        const time = new Date().toLocaleTimeString();
        setLogs(prev => [...prev.slice(-49), { time, message, type }]);
      };

      useEffect(() => {
        messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
      }, [messages]);

      useEffect(() => {
        if (!currentRoom || !username) return;

        const userRef = database.ref(`rooms/${currentRoom}/users/${username}`);
        userRef.set({ username, online: true, lastSeen: Date.now() });
        userRef.onDisconnect().update({ online: false, lastSeen: Date.now() });

        const usersRef = database.ref(`rooms/${currentRoom}/users`);
        usersRef.on('value', (snapshot) => {
          const usersData = snapshot.val() || {};
          setUsers(Object.values(usersData));
        });

        const messagesRef = database.ref(`rooms/${currentRoom}/messages`);
        messagesRef.on('value', (snapshot) => {
          const messagesData = snapshot.val() || {};
          setMessages(Object.entries(messagesData).map(([id, msg]) => ({ id, ...msg })));
        });

        const reactionsRef = database.ref(`rooms/${currentRoom}/reactions`);
        reactionsRef.on('value', (snapshot) => {
          setReactions(snapshot.val() || {});
        });

        const typingRef = database.ref(`rooms/${currentRoom}/typing`);
        typingRef.on('value', (snapshot) => {
          setTypingUsers(snapshot.val() || {});
        });

        // Listen for incoming calls
        const callRef = database.ref(`rooms/${currentRoom}/calls/${username}`);
        callRef.on('value', (snapshot) => {
          const callData = snapshot.val();
          if (callData && callData.type === 'offer' && !inCall) {
            addLog(`Incoming call from ${callData.from}`, 'info');
            setIncomingCall(callData);
          } else if (callData && callData.type === 'answer' && inCall) {
            addLog(`Call answered by ${callData.from}`, 'info');
            handleAnswer(callData);
          }
        });

        return () => {
          userRef.off();
          usersRef.off();
          messagesRef.off();
          reactionsRef.off();
          typingRef.off();
          callRef.off();
          userRef.update({ online: false, lastSeen: Date.now() });
        };
      }, [currentRoom, username, inCall]);

      const createRoom = () => {
        if (!username.trim()) {
          alert('Please enter a username');
          return;
        }
        const code = Math.random().toString(36).substring(2, 8).toUpperCase();
        setRoomCode(code);
        setCurrentRoom(code);
        setScreen('chat');
        addLog(`Room ${code} created by ${username}`, 'info');
        
        database.ref(`rooms/${code}/messages`).push({
          text: `${username} created the room`,
          type: 'system',
          timestamp: Date.now()
        });
      };

      const joinRoom = () => {
        if (!username.trim() || !roomCode.trim()) {
          alert('Please enter both username and room code');
          return;
        }
        
        database.ref(`rooms/${roomCode}`).once('value', (snapshot) => {
          if (snapshot.exists()) {
            setCurrentRoom(roomCode);
            setScreen('chat');
            addLog(`${username} joined room ${roomCode}`, 'info');
            
            database.ref(`rooms/${roomCode}/messages`).push({
              text: `${username} joined the room`,
              type: 'system',
              timestamp: Date.now()
            });
          } else {
            alert('Room not found');
          }
        });
      };

      const sendMessage = () => {
        if (!message.trim()) return;
        
        database.ref(`rooms/${currentRoom}/messages`).push({
          text: message,
          username,
          timestamp: Date.now(),
          type: 'text'
        });
        
        setMessage('');
        database.ref(`rooms/${currentRoom}/typing/${username}`).remove();
      };

      const updateTyping = () => {
        if (typingTimeoutRef.current) {
          clearTimeout(typingTimeoutRef.current);
        }
        
        database.ref(`rooms/${currentRoom}/typing/${username}`).set(true);
        
        typingTimeoutRef.current = setTimeout(() => {
          database.ref(`rooms/${currentRoom}/typing/${username}`).remove();
        }, 1000);
      };

      const addReaction = (messageId, emoji) => {
        const reactionPath = `rooms/${currentRoom}/reactions/${messageId}/${emoji}`;
        const userReactions = reactions[messageId]?.[emoji] || [];
        
        if (userReactions.includes(username)) {
          database.ref(reactionPath).set(userReactions.filter(u => u !== username));
        } else {
          database.ref(reactionPath).set([...userReactions, username]);
        }
      };

      // Camera and snap functions
      const startCamera = async () => {
        try {
          addLog('Starting camera...', 'info');
          setShowCamera(true);
          setCameraReady(false);
          
          const stream = await navigator.mediaDevices.getUserMedia({ 
            video: { facingMode: 'user' }, 
            audio: false 
          });
          
          if (videoRef.current) {
            videoRef.current.srcObject = stream;
            videoRef.current.onloadedmetadata = () => {
              setCameraReady(true);
              addLog('Camera ready!', 'info');
            };
          }
        } catch (error) {
          addLog(`Camera error: ${error.message}`, 'error');
          alert('Could not access camera. Please allow camera permissions.');
          setShowCamera(false);
        }
      };

      const takeSnap = () => {
        if (!cameraReady || !videoRef.current || !canvasRef.current) {
          addLog('Camera not ready', 'error');
          return;
        }

        try {
          const video = videoRef.current;
          const canvas = canvasRef.current;
          
          canvas.width = video.videoWidth;
          canvas.height = video.videoHeight;
          
          const ctx = canvas.getContext('2d');
          ctx.drawImage(video, 0, 0);
          
          const imageData = canvas.toDataURL('image/jpeg', 0.8);
          
          database.ref(`rooms/${currentRoom}/messages`).push({
            type: 'image',
            username,
            timestamp: Date.now(),
            imageUrl: imageData
          });
          
          // Stop camera
          const stream = video.srcObject;
          if (stream) {
            stream.getTracks().forEach(track => track.stop());
          }
          
          setShowCamera(false);
          setCameraReady(false);
          addLog('Snap sent!', 'info');
        } catch (error) {
          addLog(`Snap error: ${error.message}`, 'error');
        }
      };

      const sendImageUrl = () => {
        if (!imageUrl.trim()) return;
        
        let finalUrl = imageUrl;
        if (imageUrl.includes('giphy.com') && !imageUrl.endsWith('.gif')) {
          const giphyId = imageUrl.split('-').pop();
          finalUrl = `https://media.giphy.com/media/${giphyId}/giphy.gif`;
        }
        
        database.ref(`rooms/${currentRoom}/messages`).push({
          type: 'image',
          username,
          timestamp: Date.now(),
          imageUrl: finalUrl
        });
        
        setImageUrl('');
        setShowImageInput(false);
      };

      // Video call functions
      const startCall = async (targetUser) => {
        if (targetUser === username) {
          alert('You cannot call yourself!');
          return;
        }

        try {
          addLog(`Starting call with ${targetUser}...`, 'info');
          setIsRinging(true);
          
          const stream = await navigator.mediaDevices.getUserMedia({ 
            video: true, 
            audio: true 
          });
          
          setLocalStream(stream);
          if (localVideoRef.current) {
            localVideoRef.current.srcObject = stream;
          }

          const pc = new RTCPeerConnection({
            iceServers: [
              { urls: 'stun:stun.l.google.com:19302' },
              { urls: 'stun:stun1.l.google.com:19302' }
            ]
          });

          stream.getTracks().forEach(track => pc.addTrack(track, stream));

          pc.ontrack = (event) => {
            addLog('Received remote stream', 'info');
            setRemoteStream(event.streams[0]);
            if (remoteVideoRef.current) {
              remoteVideoRef.current.srcObject = event.streams[0];
            }
            setIsRinging(false);
          };

          pc.onicecandidate = (event) => {
            if (event.candidate) {
              database.ref(`rooms/${currentRoom}/calls/${targetUser}/candidates/${username}`).push(event.candidate.toJSON());
            }
          };

          const offer = await pc.createOffer();
          await pc.setLocalDescription(offer);

          database.ref(`rooms/${currentRoom}/calls/${targetUser}`).set({
            type: 'offer',
            from: username,
            offer: {
              type: offer.type,
              sdp: offer.sdp
            },
            timestamp: Date.now()
          });

          setPeerConnection(pc);
          setInCall(true);
          setCallWith(targetUser);
          addLog(`Calling ${targetUser}...`, 'info');

        } catch (error) {
          addLog(`Call error: ${error.message}`, 'error');
          alert('Could not start call. Please check camera/microphone permissions.');
          setIsRinging(false);
        }
      };

      const answerCall = async (caller) => {
        try {
          addLog(`Answering call from ${caller}...`, 'info');
          
          const stream = await navigator.mediaDevices.getUserMedia({ 
            video: true, 
            audio: true 
          });
          
          setLocalStream(stream);
          if (localVideoRef.current) {
            localVideoRef.current.srcObject = stream;
          }

          const pc = new RTCPeerConnection({
            iceServers: [
              { urls: 'stun:stun.l.google.com:19302' },
              { urls: 'stun:stun1.l.google.com:19302' }
            ]
          });

          stream.getTracks().forEach(track => pc.addTrack(track, stream));

          pc.ontrack = (event) => {
            addLog('Received remote stream', 'info');
            setRemoteStream(event.streams[0]);
            if (remoteVideoRef.current) {
              remoteVideoRef.current.srcObject = event.streams[0];
            }
          };

          pc.onicecandidate = (event) => {
            if (event.candidate) {
              database.ref(`rooms/${currentRoom}/calls/${caller}/candidates/${username}`).push(event.candidate.toJSON());
            }
          };

          if (incomingCall && incomingCall.offer) {
            await pc.setRemoteDescription(new RTCSessionDescription(incomingCall.offer));
            const answer = await pc.createAnswer();
            await pc.setLocalDescription(answer);

            database.ref(`rooms/${currentRoom}/calls/${caller}`).set({
              type: 'answer',
              from: username,
              answer: {
                type: answer.type,
                sdp: answer.sdp
              },
              timestamp: Date.now()
            });

            setPeerConnection(pc);
            setInCall(true);
            setCallWith(caller);
            setIncomingCall(null);
            addLog(`Call connected with ${caller}`, 'info');
          }

        } catch (error) {
          addLog(`Answer error: ${error.message}`, 'error');
          alert('Could not answer call. Please check camera/microphone permissions.');
        }
      };

      const handleAnswer = async (answerData) => {
        if (peerConnection && answerData.answer) {
          try {
            await peerConnection.setRemoteDescription(new RTCSessionDescription(answerData.answer));
            addLog('Call connected!', 'info');
            setIsRinging(false);
          } catch (error) {
            addLog(`Error setting remote description: ${error.message}`, 'error');
          }
        }
      };

      const declineCall = () => {
        if (incomingCall) {
          database.ref(`rooms/${currentRoom}/calls/${username}`).remove();
          setIncomingCall(null);
          addLog('Call declined', 'info');
        }
      };

      const endCall = () => {
        if (localStream) {
          localStream.getTracks().forEach(track => track.stop());
        }
        if (peerConnection) {
          peerConnection.close();
        }
        
        database.ref(`rooms/${currentRoom}/calls/${callWith}`).remove();
        database.ref(`rooms/${currentRoom}/calls/${username}`).remove();
        
        setInCall(false);
        setCallWith(null);
        setLocalStream(null);
        setRemoteStream(null);
        setPeerConnection(null);
        setIsRinging(false);
        addLog('Call ended', 'info');
      };

      const toggleMute = () => {
        if (localStream) {
          localStream.getAudioTracks().forEach(track => {
            track.enabled = !track.enabled;
          });
          setIsMuted(!isMuted);
        }
      };

      const toggleVideo = () => {
        if (localStream) {
          localStream.getVideoTracks().forEach(track => {
            track.enabled = !track.enabled;
          });
          setIsVideoOff(!isVideoOff);
        }
      };

      // Games
      const openGame = (title, url, icon) => {
        const newWindow = {
          id: Date.now(),
          title,
          url,
          icon
        };
        setOpenGameWindows(prev => [...prev, newWindow]);
      };

      const closeGameWindow = (id) => {
        setOpenGameWindows(prev => prev.filter(w => w.id !== id));
      };

      const games = [
        { title: '2048', url: 'https://play2048.co/', icon: 'üéÆ' },
        { title: 'Tetris', url: 'https://tetris.com/play-tetris', icon: 'üß±' },
        { title: 'Snake', url: 'https://playsnake.org/', icon: 'üêç' },
        { title: 'Pac-Man', url: 'https://www.google.com/logos/2010/pacman10-i.html', icon: 'üëæ' },
        { title: 'Chess', url: 'https://www.chess.com/play/computer', icon: '‚ôüÔ∏è' }
      ];

      if (screen === 'home') {
        return (
          <div style={{ minHeight: '100vh', display: 'flex', alignItems: 'center', justifyContent: 'center', padding: '20px' }}>
            <div style={{ maxWidth: '500px', width: '100%' }}>
              <h1 className="glow-text" style={{ fontSize: '48px', fontWeight: 'bold', marginBottom: '10px', textAlign: 'center' }}>Anonymous Chat</h1>
              <p style={{ color: '#999', textAlign: 'center', marginBottom: '40px', fontSize: '16px' }}>
                Connect anonymously ‚Ä¢ Video calls ‚Ä¢ Games ‚Ä¢ Fun
              </p>
              
              <div style={{ background: '#1a1a1a', border: '1px solid #333', borderRadius: '20px', padding: '30px' }} className="glow-border">
                <input
                  type="text"
                  value={username}
                  onChange={(e) => setUsername(e.target.value)}
                  onKeyDown={(e) => e.key === 'Enter' && (roomCode ? joinRoom() : createRoom())}
                  placeholder="Enter your username..."
                  style={{ width: '100%', padding: '15px', background: '#0a0a0a', border: '1px solid #333', borderRadius: '10px', color: '#fff', fontSize: '16px', marginBottom: '20px' }}
                />
                
                <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '15px', marginBottom: '20px' }}>
                  <button onClick={createRoom} className="glow-button" style={{ background: '#fff', color: '#000', padding: '15px', borderRadius: '10px', border: 'none', fontSize: '16px', fontWeight: 'bold', cursor: 'pointer' }}>
                    Create Room
                  </button>
                  <button onClick={() => setScreen('join')} className="glow-button" style={{ background: '#1a1a1a', color: '#fff', padding: '15px', borderRadius: '10px', border: '1px solid #333', fontSize: '16px', fontWeight: 'bold', cursor: 'pointer' }}>
                    Join Room
                  </button>
                </div>
              </div>
            </div>
          </div>
        );
      }

      if (screen === 'join') {
        return (
          <div style={{ minHeight: '100vh', display: 'flex', alignItems: 'center', justifyContent: 'center', padding: '20px' }}>
            <div style={{ maxWidth: '500px', width: '100%' }}>
              <h1 className="glow-text" style={{ fontSize: '48px', fontWeight: 'bold', marginBottom: '10px', textAlign: 'center' }}>Join Room</h1>
              
              <div style={{ background: '#1a1a1a', border: '1px solid #333', borderRadius: '20px', padding: '30px' }} className="glow-border">
                <input
                  type="text"
                  value={username}
                  onChange={(e) => setUsername(e.target.value)}
                  placeholder="Enter your username..."
                  style={{ width: '100%', padding: '15px', background: '#0a0a0a', border: '1px solid #333', borderRadius: '10px', color: '#fff', fontSize: '16px', marginBottom: '15px' }}
                />
                
                <input
                  type="text"
                  value={roomCode}
                  onChange={(e) => setRoomCode(e.target.value.toUpperCase())}
                  onKeyDown={(e) => e.key === 'Enter' && joinRoom()}
                  placeholder="Enter room code..."
                  style={{ width: '100%', padding: '15px', background: '#0a0a0a', border: '1px solid #333', borderRadius: '10px', color: '#fff', fontSize: '16px', marginBottom: '20px' }}
                />
                
                <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '15px' }}>
                  <button onClick={joinRoom} className="glow-button" style={{ background: '#fff', color: '#000', padding: '15px', borderRadius: '10px', border: 'none', fontSize: '16px', fontWeight: 'bold', cursor: 'pointer' }}>
                    Join
                  </button>
                  <button onClick={() => setScreen('home')} className="glow-button" style={{ background: '#1a1a1a', color: '#fff', padding: '15px', borderRadius: '10px', border: '1px solid #333', fontSize: '16px', fontWeight: 'bold', cursor: 'pointer' }}>
                    Back
                  </button>
                </div>
              </div>
            </div>
          </div>
        );
      }

      if (screen === 'chat') {
        const onlineUsers = users.filter(u => u.online && u.username !== username);
        const typingList = Object.keys(typingUsers).filter(u => u !== username);

        return (
          <>
            <div style={{ height: '100vh', display: 'flex', flexDirection: 'column', background: '#000' }}>
              {/* Header */}
              <div style={{ background: '#1a1a1a', borderBottom: '1px solid #333', padding: '20px' }}>
                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '15px' }}>
                  <div>
                    <h2 className="glow-text" style={{ fontSize: '24px', fontWeight: 'bold', marginBottom: '5px' }}>Room: {currentRoom}</h2>
                    <p style={{ color: '#999', fontSize: '14px' }}>{onlineUsers.length} online</p>
                  </div>
                  <button onClick={() => { setScreen('home'); setCurrentRoom(null); }} className="glow-button" style={{ background: '#ff3b30', color: '#fff', padding: '12px 20px', borderRadius: '10px', border: 'none', fontSize: '14px', fontWeight: 'bold', cursor: 'pointer' }}>
                    Leave
                  </button>
                </div>

                {/* Online Users */}
                <div style={{ display: 'flex', gap: '10px', flexWrap: 'wrap' }}>
                  {onlineUsers.map(user => (
                    <div key={user.username} style={{ background: '#0a0a0a', border: '1px solid #333', borderRadius: '20px', padding: '8px 15px', display: 'flex', alignItems: 'center', gap: '8px' }}>
                      <div style={{ width: '8px', height: '8px', borderRadius: '50%', background: '#00ff00' }} />
                      <span style={{ fontSize: '14px' }}>{user.username}</span>
                      <button 
                        onClick={() => startCall(user.username)} 
                        className="glow-button"
                        style={{ 
                          background: '#007aff', 
                          color: '#fff', 
                          border: 'none', 
                          borderRadius: '50%', 
                          width: '30px', 
                          height: '30px', 
                          cursor: 'pointer',
                          display: 'flex',
                          alignItems: 'center',
                          justifyContent: 'center',
                          fontSize: '16px'
                        }}
                      >
                        üìû
                      </button>
                    </div>
                  ))}
                </div>
              </div>

              {/* Games Bar */}
              <div style={{ background: '#0a0a0a', borderBottom: '1px solid #333', padding: '15px', display: 'flex', gap: '10px', overflowX: 'auto' }}>
                {games.map(game => (
                  <button
                    key={game.title}
                    onClick={() => openGame(game.title, game.url, game.icon)}
                    className="glow-button"
                    style={{ 
                      background: '#1a1a1a', 
                      color: '#fff', 
                      border: '1px solid #333', 
                      borderRadius: '10px', 
                      padding: '10px 20px', 
                      cursor: 'pointer',
                      display: 'flex',
                      alignItems: 'center',
                      gap: '8px',
                      whiteSpace: 'nowrap',
                      fontSize: '14px'
                    }}
                  >
                    <span style={{ fontSize: '20px' }}>{game.icon}</span>
                    {game.title}
                  </button>
                ))}
              </div>

              {/* Messages */}
              <div style={{ flex: 1, overflowY: 'auto', padding: '20px' }}>
                {messages.map((msg) => {
                  if (msg.type === 'system') {
                    return (
                      <div key={msg.id} className="system-message">
                        {msg.text}
                      </div>
                    );
                  }

                  const isOwn = msg.username === username;
                  const msgReactions = reactions[msg.id] || {};

                  return (
                    <div key={msg.id} style={{ marginBottom: '15px', display: 'flex', justifyContent: isOwn ? 'flex-end' : 'flex-start' }}>
                      <div className="message-bubble" style={{ maxWidth: '70%', position: 'relative' }}>
                        <div className="message-actions">
                          <div style={{ position: 'relative' }}>
                            <button 
                              onClick={() => setShowEmojiPicker(showEmojiPicker === msg.id ? null : msg.id)}
                              className="action-btn"
                            >
                              üòä
                            </button>
                            {showEmojiPicker === msg.id && (
                              <div className="emoji-picker">
                                {emojis.map(emoji => (
                                  <button
                                    key={emoji}
                                    onClick={() => {
                                      addReaction(msg.id, emoji);
                                      setShowEmojiPicker(null);
                                    }}
                                    className="emoji-btn"
                                  >
                                    {emoji}
                                  </button>
                                ))}
                              </div>
                            )}
                          </div>
                        </div>

                        <div style={{ background: isOwn ? '#007aff' : '#1a1a1a', padding: '12px 16px', borderRadius: '18px', border: isOwn ? 'none' : '1px solid #333' }}>
                          {!isOwn && <div style={{ fontSize: '12px', color: '#999', marginBottom: '5px', fontWeight: 'bold' }}>{msg.username}</div>}
                          
                          {msg.type === 'image' && (
                            <img src={msg.imageUrl} alt="Shared" style={{ maxWidth: '100%', borderRadius: '10px', marginTop: '5px' }} />
                          )}
                          
                          {msg.type === 'text' && (
                            <div style={{ fontSize: '15px', lineHeight: '1.4' }}>{msg.text}</div>
                          )}
                          
                          <div style={{ fontSize: '11px', color: isOwn ? 'rgba(255,255,255,0.7)' : '#666', marginTop: '5px' }}>
                            {new Date(msg.timestamp).toLocaleTimeString()}
                          </div>
                        </div>

                        {Object.keys(msgReactions).length > 0 && (
                          <div className="reaction-container">
                            {Object.entries(msgReactions).map(([emoji, users]) => (
                              users.length > 0 && (
                                <div
                                  key={emoji}
                                  className={`reaction ${users.includes(username) ? 'active' : ''}`}
                                  onClick={() => addReaction(msg.id, emoji)}
                                >
                                  <span>{emoji}</span>
                                  <span>{users.length}</span>
                                </div>
                              )
                            ))}
                          </div>
                        )}
                      </div>
                    </div>
                  );
                })}

                {typingList.length > 0 && (
                  <div className="typing-indicator">
                    {typingList.join(', ')} {typingList.length === 1 ? 'is' : 'are'} typing...
                  </div>
                )}

                <div ref={messagesEndRef} />
              </div>

              {/* Input Area */}
              <div style={{ background: '#1a1a1a', borderTop: '1px solid #333', padding: '20px' }}>
                {showCamera && (
                  <div style={{ marginBottom: '15px', background: '#0a0a0a', padding: '20px', borderRadius: '15px', border: '1px solid #333' }}>
                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '15px' }}>
                      <h3 style={{ fontSize: '16px', fontWeight: 'bold' }}>üì∏ Camera</h3>
                      <button 
                        onClick={() => {
                          const stream = videoRef.current?.srcObject;
                          if (stream) {
                            stream.getTracks().forEach(track => track.stop());
                          }
                          setShowCamera(false);
                          setCameraReady(false);
                        }} 
                        style={{ background: 'transparent', border: 'none', color: '#999', cursor: 'pointer', fontSize: '24px' }}
                      >
                        √ó
                      </button>
                    </div>
                    {cameraReady && (
                      <div style={{ marginBottom: '10px', padding: '8px', background: '#0a2a0a', border: '1px solid #00ff88', borderRadius: '8px', color: '#88ffcc', fontSize: '12px' }}>
                        ‚úÖ <strong>Camera Ready!</strong> You can now take a snap
                      </div>
                    )}
                    <video ref={videoRef} autoPlay playsInline muted style={{ width: '100%', borderRadius: '10px', marginBottom: '15px', background: '#000' }} />
                    <canvas ref={canvasRef} style={{ display: 'none' }} />
                    <button 
                      onClick={takeSnap} 
                      disabled={!cameraReady}
                      className="glow-button" 
                      style={{ 
                        width: '100%', 
                        background: cameraReady ? '#fff' : '#333', 
                        color: cameraReady ? '#000' : '#666', 
                        padding: '15px', 
                        borderRadius: '10px', 
                        border: 'none', 
                        fontSize: '16px', 
                        fontWeight: 'bold', 
                        cursor: cameraReady ? 'pointer' : 'not-allowed',
                        opacity: cameraReady ? 1 : 0.5
                      }}
                    >
                      {cameraReady ? 'üì∏ SNAP & SEND' : '‚è≥ WAITING FOR CAMERA...'}
                    </button>
                  </div>
                )}

                {showImageInput && (
                  <div style={{ marginBottom: '15px', background: '#1a1a1a', padding: '20px', borderRadius: '15px', border: '1px solid #333' }}>
                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '15px' }}>
                      <h3 style={{ fontSize: '16px', fontWeight: 'bold' }}>üñºÔ∏è Send Image/GIF</h3>
                      <button onClick={() => setShowImageInput(false)} style={{ background: 'transparent', border: 'none', color: '#999', cursor: 'pointer', fontSize: '24px' }}>√ó</button>
                    </div>
                    <div style={{ marginBottom: '10px', padding: '8px', background: '#0a2a0a', border: '1px solid #00ff88', borderRadius: '8px', color: '#88ffcc', fontSize: '12px' }}>
                      üí° <strong>Tip:</strong> You can paste Giphy page URLs directly! Or use "Share" ‚Üí "Copy GIF Link" from Giphy/Tenor
                    </div>
                    <input
                      type="text"
                      value={imageUrl}
                      onChange={(e) => setImageUrl(e.target.value)}
                      onKeyDown={(e) => e.key === 'Enter' && sendImageUrl()}
                      placeholder="Paste image or GIF URL..."
                      style={{ width: '100%', padding: '15px', background: '#0a0a0a', border: '1px solid #333', borderRadius: '10px', color: '#fff', fontSize: '15px', marginBottom: '15px' }}
                    />
                    {imageUrl && (
                      <div style={{ marginBottom: '15px', textAlign: 'center' }}>
                        <img src={imageUrl} alt="Preview" style={{ maxWidth: '100%', maxHeight: '200px', borderRadius: '10px' }} onError={(e) => e.target.style.display = 'none'} />
                      </div>
                    )}
                    <button onClick={sendImageUrl} className="glow-button" style={{ width: '100%', background: '#fff', color: '#000', padding: '15px', borderRadius: '10px', border: 'none', fontSize: '16px', fontWeight: 'bold', cursor: 'pointer' }}>
                      üì§ SEND IMAGE
                    </button>
                  </div>
                )}

                <div style={{ display: 'flex', gap: '10px' }}>
                  <input
                    type="text"
                    value={message}
                    onChange={(e) => {
                      setMessage(e.target.value);
                      updateTyping();
                    }}
                    onKeyDown={(e) => e.key === 'Enter' && sendMessage()}
                    placeholder="Type a message..."
                    style={{ flex: 1, padding: '15px', background: '#1a1a1a', border: '1px solid #333', borderRadius: '10px', color: '#fff', fontSize: '15px' }}
                  />
                  <button onClick={sendMessage} className="glow-button" style={{ background: '#fff', color: '#000', padding: '15px 30px', borderRadius: '10px', border: 'none', fontSize: '16px', fontWeight: 'bold', cursor: 'pointer', display: 'flex', alignItems: 'center', gap: '8px' }}>
                    <Send /> Send
                  </button>
                  <button onClick={startCamera} className="glow-button" style={{ background: '#1a1a1a', color: '#fff', padding: '15px 30px', borderRadius: '10px', border: '1px solid #333', fontSize: '16px', fontWeight: 'bold', cursor: 'pointer' }}>
                    üì∏
                  </button>
                  <button onClick={() => setShowImageInput(!showImageInput)} className="glow-button" style={{ background: '#1a1a1a', color: '#fff', padding: '15px 30px', borderRadius: '10px', border: '1px solid #333', fontSize: '16px', fontWeight: 'bold', cursor: 'pointer' }}>
                    üñºÔ∏è
                  </button>
                </div>
              </div>
            </div>

            {/* Render open game windows */}
            {openGameWindows.map(window => (
              <MinimizedWindow 
                key={window.id}
                title={window.title}
                url={window.url}
                icon={window.icon}
                onClose={() => closeGameWindow(window.id)}
              />
            ))}

            {/* Video Call Modal */}
            {inCall && (
              <div className="video-call-modal">
                <div className="video-container">
                  <video 
                    ref={remoteVideoRef} 
                    autoPlay 
                    playsInline 
                    className="remote-video"
                    style={{ display: remoteStream ? 'block' : 'none' }}
                  />
                  {!remoteStream && (
                    <div className="call-status calling-status">
                      <div className="ringing-icon" style={{ fontSize: '64px', marginBottom: '20px' }}>üìû</div>
                      <div style={{ fontSize: '24px', marginBottom: '10px' }}>
                        {isRinging ? 'Ringing...' : 'Calling'}
                      </div>
                      <div style={{ fontSize: '18px', fontWeight: 'bold', marginBottom: '10px' }}>{callWith}</div>
                      <div style={{ fontSize: '14px', color: '#999' }}>Waiting for them to answer...</div>
                    </div>
                  )}
                  <video 
                    ref={localVideoRef} 
                    autoPlay 
                    playsInline 
                    muted 
                    className="local-video"
                    style={{ display: isVideoOff ? 'none' : 'block' }}
                  />
                  {isVideoOff && (
                    <div className="local-video" style={{ display: 'flex', alignItems: 'center', justifyContent: 'center', background: '#1a1a1a' }}>
                      <span style={{ fontSize: '48px' }}>üìπ</span>
                    </div>
                  )}
                  <div className="call-controls">
                    <button 
                      onClick={toggleMute} 
                      className={`call-btn mute ${isMuted ? 'active' : ''}`}
                      title={isMuted ? 'Unmute' : 'Mute'}
                    >
                      {isMuted ? 'üîá' : 'üé§'}
                    </button>
                    <button 
                      onClick={toggleVideo} 
                      className={`call-btn video-toggle ${isVideoOff ? 'active' : ''}`}
                      title={isVideoOff ? 'Turn on camera' : 'Turn off camera'}
                    >
                      {isVideoOff ? 'üìπ' : 'üì∑'}
                    </button>
                    <button 
                      onClick={endCall} 
                      className="call-btn end"
                      title="End call"
                    >
                      ‚òéÔ∏è
                    </button>
                  </div>
                </div>
              </div>
            )}

            {/* Incoming Call */}
            {incomingCall && !inCall && (
              <div style={{ position: 'fixed', top: 0, left: 0, right: 0, bottom: 0, background: 'rgba(0,0,0,0.95)', display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 10001 }}>
                <div className="incoming-call">
                  <div className="ringing-icon" style={{ fontSize: '64px', marginBottom: '20px' }}>üìû</div>
                  <h2 style={{ fontSize: '24px', fontWeight: 'bold', marginBottom: '10px' }}>Incoming Call</h2>
                  <p style={{ fontSize: '18px', color: '#999', marginBottom: '30px' }}>{incomingCall.from} is calling you...</p>
                  <div style={{ display: 'flex', gap: '15px', justifyContent: 'center' }}>
                    <button 
                      onClick={() => answerCall(incomingCall.from)} 
                      className="glow-button" 
                      style={{ 
                        background: '#00ff00', 
                        color: '#000', 
                        padding: '15px 40px', 
                        borderRadius: '50px', 
                        border: 'none', 
                        fontSize: '18px', 
                        fontWeight: 'bold', 
                        cursor: 'pointer',
                        display: 'flex',
                        alignItems: 'center',
                        gap: '10px'
                      }}
                    >
                      üìû Answer
                    </button>
                    <button 
                      onClick={declineCall} 
                      style={{ 
                        background: '#ff3b30', 
                        color: '#fff', 
                        padding: '15px 40px', 
                        borderRadius: '50px', 
                        border: 'none', 
                        fontSize: '18px', 
                        fontWeight: 'bold', 
                        cursor: 'pointer',
                        display: 'flex',
                        alignItems: 'center',
                        gap: '10px'
                      }}
                    >
                      ‚ùå Decline
                    </button>
                  </div>
                </div>
              </div>
            )}

            {!showDebug && (
              <div className="debug-toggle" onClick={() => setShowDebug(true)} style={{ position: 'fixed', bottom: '20px', right: '20px', background: '#1a1a1a', border: '1px solid #333', borderRadius: '50%', width: '50px', height: '50px', display: 'flex', alignItems: 'center', justifyContent: 'center', cursor: 'pointer', zIndex: 9999 }}>
                <Bug />
              </div>
            )}
            {showDebug && <DebugConsole logs={logs} onClose={() => setShowDebug(false)} />}
          </>
        );
      }

      return null;
    }

    ReactDOM.render(<ChatroomApp />, document.getElementById('root'));
  </script>
</body>
</html>
