<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Anonymous Chatrooms</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #000;
      color: #fff;
    }

    @keyframes glow {
      0%, 100% { filter: drop-shadow(0 0 5px rgba(255, 255, 255, 0.5)); }
      50% { filter: drop-shadow(0 0 15px rgba(255, 255, 255, 0.8)); }
    }

    .glow {
      animation: glow 2s ease-in-out infinite;
    }

    .glow-text {
      text-shadow: 0 0 10px rgba(255, 255, 255, 0.8), 0 0 20px rgba(255, 255, 255, 0.4);
    }

    .glow-border {
      box-shadow: 0 0 15px rgba(255, 255, 255, 0.3), inset 0 0 15px rgba(255, 255, 255, 0.1);
    }

    .glow-button {
      box-shadow: 0 0 20px rgba(255, 255, 255, 0.4);
      transition: all 0.3s ease;
    }

    .glow-button:hover {
      box-shadow: 0 0 30px rgba(255, 255, 255, 0.7);
      background: #fff !important;
      color: #000 !important;
    }

    input:focus, textarea:focus {
      outline: none;
      box-shadow: 0 0 20px rgba(255, 255, 255, 0.5);
    }

    .message-bubble {
      transition: all 0.3s ease;
      position: relative;
    }

    .message-bubble:hover {
      transform: translateY(-2px);
    }

    .message-bubble:hover .message-actions {
      opacity: 1;
      pointer-events: auto;
    }

    .message-actions {
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s;
      position: absolute;
      top: -5px;
      right: 5px;
      display: flex;
      gap: 5px;
      z-index: 10;
    }

    .action-btn {
      background: rgba(0, 0, 0, 0.9);
      border: 1px solid rgba(255, 255, 255, 0.3);
      padding: 6px 10px;
      border-radius: 8px;
      cursor: pointer;
      color: #fff;
      font-size: 14px;
      transition: all 0.2s;
      backdrop-filter: blur(10px);
    }

    .action-btn:hover {
      background: rgba(255, 255, 255, 0.3);
      border-color: #fff;
      transform: scale(1.1);
    }

    .emoji-picker {
      position: absolute;
      bottom: 100%;
      right: 0;
      background: #1a1a1a;
      border: 1px solid #333;
      border-radius: 10px;
      padding: 10px;
      display: grid;
      grid-template-columns: repeat(6, 1fr);
      gap: 5px;
      margin-bottom: 5px;
      box-shadow: 0 -5px 20px rgba(0, 0, 0, 0.5);
      z-index: 1000;
    }

    .emoji-btn {
      background: transparent;
      border: none;
      font-size: 24px;
      cursor: pointer;
      padding: 5px;
      border-radius: 5px;
      transition: all 0.2s;
    }

    .emoji-btn:hover {
      background: #2a2a2a;
      transform: scale(1.2);
    }

    .reaction-container {
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
      margin-top: 8px;
    }

    .reaction {
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 12px;
      padding: 4px 10px;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 4px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .reaction:hover {
      background: rgba(255, 255, 255, 0.2);
      transform: scale(1.05);
    }

    .reaction.active {
      background: rgba(255, 255, 255, 0.3);
      border-color: #fff;
      font-weight: bold;
    }

    .typing-indicator {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid #333;
      border-radius: 10px;
      padding: 10px 15px;
      margin-bottom: 10px;
      font-size: 13px;
      color: #999;
      font-style: italic;
    }

    .system-message {
      text-align: center;
      color: #666;
      font-size: 13px;
      font-style: italic;
      padding: 8px;
      margin: 10px 0;
      background: rgba(255, 255, 255, 0.02);
      border-radius: 8px;
    }

    .reply-preview {
      background: rgba(255, 255, 255, 0.05);
      border-left: 3px solid #666;
      padding: 10px 15px;
      margin-bottom: 10px;
      border-radius: 5px;
      font-size: 13px;
    }

    .reply-to {
      background: rgba(255, 255, 255, 0.05);
      border-left: 3px solid currentColor;
      padding: 6px 10px;
      margin-bottom: 8px;
      border-radius: 3px;
      font-size: 12px;
      opacity: 0.8;
    }

    .debug-console {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: rgba(0, 0, 0, 0.95);
      border: 1px solid #333;
      border-radius: 10px;
      padding: 15px;
      max-width: 400px;
      max-height: 300px;
      overflow-y: auto;
      font-size: 12px;
      font-family: monospace;
      z-index: 9999;
    }

    .debug-log {
      margin-bottom: 5px;
      padding: 5px;
      border-radius: 3px;
    }

    .debug-log.info {
      color: #4a9eff;
    }

    .debug-log.success {
      color: #4ade80;
    }

    .debug-log.error {
      color: #f87171;
      background: rgba(248, 113, 113, 0.1);
    }

    .debug-log.warning {
      color: #fbbf24;
    }

    .debug-toggle {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: #1a1a1a;
      border: 1px solid #333;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      z-index: 9998;
      transition: all 0.3s;
    }

    .debug-toggle:hover {
      background: #2a2a2a;
      transform: scale(1.1);
    }

    ::-webkit-scrollbar {
      width: 10px;
    }

    ::-webkit-scrollbar-track {
      background: #1a1a1a;
    }

    ::-webkit-scrollbar-thumb {
      background: #fff;
      border-radius: 5px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: #ccc;
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    const firebaseConfig = {
      apiKey: "AIzaSyCR9UiBA6mg3J5a6WGtPK9F76E_ul1D1_c",
      authDomain: "chatroom-60410.firebaseapp.com",
      databaseURL: "https://chatroom-60410-default-rtdb.firebaseio.com",
      projectId: "chatroom-60410",
      storageBucket: "chatroom-60410.firebasestorage.app",
      messagingSenderId: "1074130659134",
      appId: "1:1074130659134:web:06b77a69a0c1d2ee47ee6f",
      measurementId: "G-ENN9HEXNDB"
    };

    let db = null;
    const debugLogs = [];
    
    const addDebugLog = (message, type = 'info') => {
      const timestamp = new Date().toLocaleTimeString();
      debugLogs.push({ message, type, timestamp });
      if (debugLogs.length > 50) debugLogs.shift();
      console.log(`[${type.toUpperCase()}] ${message}`);
    };

    try {
      if (!firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
        addDebugLog('Firebase initialized', 'success');
      }
      db = firebase.database();
      addDebugLog('Database connection established', 'success');
    } catch (error) {
      addDebugLog(`Firebase error: ${error.message}`, 'error');
    }

    const EMOJIS = ['üòÄ', 'üòÇ', '‚ù§Ô∏è', 'üëç', 'üî•', 'üéâ', 'üòç', 'ü§î', 'üëÄ', 'üíØ', '‚ú®', 'üöÄ'];

    function MessageCircle() {
      return <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>;
    }

    function Send() {
      return <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>;
    }

    function Users() {
      return <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>;
    }

    function Plus() {
      return <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>;
    }

    function Lock() {
      return <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>;
    }

    function LogOut() {
      return <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"></line></svg>;
    }

    function Trash() {
      return <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>;
    }

    function Smile() {
      return <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="10"/><path d="M8 14s1.5 2 4 2 4-2 4-2"/><line x1="9" y1="9" x2="9.01" y2="9"/><line x1="15" y1="9" x2="15.01" y2="9"/></svg>;
    }

    function UserX() {
      return <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="8.5" cy="7" r="4"/><line x1="18" y1="8" x2="23" y2="13"/><line x1="23" y1="8" x2="18" y2="13"/></svg>;
    }

    function Bug() {
      return <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="8" y="6" width="8" height="14" rx="4"/><path d="M6 12h12M8 18v-2M16 18v-2M8 6V4M16 6V4M19 9l2-2M5 9L3 7M19 15l2 2M5 15l-2 2"/></svg>;
    }

    function DebugConsole({ logs, onClose }) {
      return (
        <div className="debug-console">
          <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '10px', borderBottom: '1px solid #333', paddingBottom: '10px' }}>
            <div style={{ fontWeight: 'bold', color: '#fff' }}>üêõ Debug Console</div>
            <button onClick={onClose} style={{ background: 'transparent', border: 'none', color: '#999', cursor: 'pointer', fontSize: '18px' }}>√ó</button>
          </div>
          {logs.length === 0 ? (
            <div style={{ color: '#666', textAlign: 'center', padding: '20px' }}>No logs yet...</div>
          ) : (
            logs.map((log, index) => (
              <div key={index} className={`debug-log ${log.type}`}>
                <span style={{ color: '#666' }}>[{log.timestamp}]</span> {log.message}
              </div>
            ))
          )}
        </div>
      );
    }

    function ChatroomApp() {
      const [currentView, setCurrentView] = useState('start');
      const [username, setUsername] = useState('');
      const [tempUsername, setTempUsername] = useState('');
      const [currentRoom, setCurrentRoom] = useState(null);
      const [newRoomName, setNewRoomName] = useState('');
      const [newRoomPassword, setNewRoomPassword] = useState('');
      const [message, setMessage] = useState('');
      const [rooms, setRooms] = useState([]);
      const [messages, setMessages] = useState([]);
      const [error, setError] = useState('');
      const [onlineCount, setOnlineCount] = useState(0);
      const [replyTo, setReplyTo] = useState(null);
      const [showEmojiPicker, setShowEmojiPicker] = useState(null);
      const [typingUsers, setTypingUsers] = useState([]);
      const [roomUsers, setRoomUsers] = useState([]);
      const [showDebug, setShowDebug] = useState(false);
      const [logs, setLogs] = useState([]);
      const messagesEndRef = useRef(null);
      const typingTimeoutRef = useRef(null);
      const [showCamera, setShowCamera] = useState(false);
      const [stream, setStream] = useState(null);
      const videoRef = useRef(null);
      const canvasRef = useRef(null);


      useEffect(() => {
        const interval = setInterval(() => {
          setLogs([...debugLogs]);
        }, 1000);
        return () => clearInterval(interval);
      }, []);

      useEffect(() => {
        messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
      }, [messages]);

      useEffect(() => {
        if (currentRoom && db) {
          addDebugLog(`Listening to messages in room: ${currentRoom}`, 'info');
          const messagesRef = db.ref(`messages/${currentRoom}`);
          messagesRef.on('value', (snapshot) => {
            const data = snapshot.val();
            if (data) {
              const messageList = Object.values(data)
                .filter(msg => msg.text || msg.type === 'system' || msg.type === 'snap')
                .sort((a, b) => a.timestamp - b.timestamp);
              setMessages(messageList);
              addDebugLog(`Loaded ${messageList.length} messages`, 'success');
            } else {
              setMessages([]);
              addDebugLog('No messages in room', 'info');
            }
          });
          return () => {
            messagesRef.off();
            addDebugLog('Stopped listening to messages', 'info');
          };
        }
      }, [currentRoom]);

      useEffect(() => {
        if ((currentView === 'lobby' || currentView === 'create' || currentView === 'room') && db) {
          addDebugLog('Listening to rooms', 'info');
          const roomsRef = db.ref('rooms');
          roomsRef.on('value', (snapshot) => {
            const data = snapshot.val();
            if (data) {
              const roomList = Object.values(data).sort((a, b) => b.createdAt - a.createdAt);
              setRooms(roomList);
              addDebugLog(`Found ${roomList.length} rooms`, 'success');
            } else {
              setRooms([]);
              addDebugLog('No rooms available', 'info');
            }
          });
          return () => {
            roomsRef.off();
            addDebugLog('Stopped listening to rooms', 'info');
          };
        }
      }, [currentView]);

      useEffect(() => {
        if ((currentView === 'lobby' || currentView === 'create' || currentView === 'room') && db) {
          const onlineRef = db.ref('online');
          onlineRef.on('value', (snapshot) => {
            const data = snapshot.val();
            if (data) {
              const now = Date.now();
              const active = Object.values(data).filter(time => now - time < 60000).length;
              setOnlineCount(active);
            } else {
              setOnlineCount(0);
            }
          });
          return () => onlineRef.off();
        }
      }, [currentView]);

      useEffect(() => {
        if (currentRoom && username && db) {
          addDebugLog(`Joining room as ${username}`, 'info');
          const roomUserRef = db.ref(`roomUsers/${currentRoom}/${username}`);
          roomUserRef.set({ username, timestamp: Date.now() });
          roomUserRef.onDisconnect().remove();

          const roomUsersRef = db.ref(`roomUsers/${currentRoom}`);
          roomUsersRef.on('value', (snapshot) => {
            const data = snapshot.val();
            if (data) {
              const users = Object.values(data).map(u => u.username);
              setRoomUsers(users);
              addDebugLog(`Room users: ${users.join(', ')}`, 'info');
            } else {
              setRoomUsers([]);
            }
          });

          return () => {
            roomUserRef.remove();
            roomUsersRef.off();
          };
        }
      }, [currentRoom, username]);

      useEffect(() => {
        if (currentRoom && db) {
          const typingRef = db.ref(`typing/${currentRoom}`);
          typingRef.on('value', (snapshot) => {
            const data = snapshot.val();
            if (data) {
              const now = Date.now();
              const activeTyping = Object.entries(data)
                .filter(([user, time]) => user !== username && now - time < 3000)
                .map(([user]) => user);
              setTypingUsers(activeTyping);
            } else {
              setTypingUsers([]);
            }
          });
          return () => typingRef.off();
        }
      }, [currentRoom, username]);

      useEffect(() => {
        if (username && db) {
          const userRef = db.ref(`online/${username}`);
          const updatePresence = () => {
            userRef.set(Date.now());
          };
          updatePresence();
          userRef.onDisconnect().remove();
          const interval = setInterval(updatePresence, 30000);
          addDebugLog(`User ${username} set as online`, 'success');
          return () => clearInterval(interval);
        }
      }, [username]);


useEffect(() => {
  return () => {
    if (stream) {
      stream.getTracks().forEach(track => track.stop());
    }
  };
}, [stream]);

const startCamera = async () => {
  try {
    const mediaStream = await navigator.mediaDevices.getUserMedia({ 
      video: { width: 640, height: 480 } 
    });
    setStream(mediaStream);
    setShowCamera(true);
    setTimeout(() => {
      if (videoRef.current) {
        videoRef.current.srcObject = mediaStream;
      }
    }, 100);
    addDebugLog('Camera started', 'success');
  } catch (err) {
    alert('Camera access denied or unavailable');
    addDebugLog(`Camera error: ${err.message}`, 'error');
  }
};

const stopCamera = () => {
  if (stream) {
    stream.getTracks().forEach(track => track.stop());
    setStream(null);
  }
  setShowCamera(false);
  addDebugLog('Camera stopped', 'info');
};

const takeSnap = async () => {
  if (!videoRef.current || !canvasRef.current) return;
  
  const canvas = canvasRef.current;
  const video = videoRef.current;
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  canvas.getContext('2d').drawImage(video, 0, 0);
  
  const imageData = canvas.toDataURL('image/jpeg', 0.7);
  
  const msgId = Date.now().toString() + Math.random().toString(36).substr(2, 9);
  const newMsg = {
    id: msgId,
    username,
    type: 'snap',
    image: imageData,
    timestamp: Date.now(),
    reactions: {}
  };
  
  try {
    await db.ref(`messages/${currentRoom}/${msgId}`).set(newMsg);
    addDebugLog('Snap sent', 'success');
    stopCamera();
  } catch (err) {
    setError('Failed to send snap');
    addDebugLog(`Snap send error: ${err.message}`, 'error');
  }
};

      const updateTyping = () => {
        if (!currentRoom || !username || !db) return;
        db.ref(`typing/${currentRoom}/${username}`).set(Date.now());
        if (typingTimeoutRef.current) {
          clearTimeout(typingTimeoutRef.current);
        }
        typingTimeoutRef.current = setTimeout(() => {
          db.ref(`typing/${currentRoom}/${username}`).remove();
        }, 3000);
      };

      const createRoom = async () => {
        if (!newRoomName.trim()) {
          setError('Room name required');
          addDebugLog('Room creation failed: name required', 'error');
          return;
        }
        const roomId = Date.now().toString();
        const room = {
          id: roomId,
          name: newRoomName.trim(),
          password: newRoomPassword,
          createdAt: Date.now(),
          owner: username
        };
        try {
          await db.ref(`rooms/${roomId}`).set(room);
          addDebugLog(`Room created: ${newRoomName}`, 'success');
          setCurrentRoom(roomId);
          setNewRoomName('');
          setNewRoomPassword('');
          setError('');
          setCurrentView('room');
        } catch (err) {
          setError('Failed to create room');
          addDebugLog(`Room creation error: ${err.message}`, 'error');
        }
      };

      const joinRoom = (room, password = '') => {
        if (room.password && room.password !== password) {
          setError('Incorrect password');
          addDebugLog(`Failed to join ${room.name}: wrong password`, 'error');
          return;
        }
        setCurrentRoom(room.id);
        setCurrentView('room');
        setError('');
        addDebugLog(`Joined room: ${room.name}`, 'success');
      };

      const sendMessage = async () => {
        if (!message.trim() || !currentRoom) return;
        const msgId = Date.now().toString() + Math.random().toString(36).substr(2, 9);
        const newMsg = {
          id: msgId,
          username,
          text: message.trim(),
          timestamp: Date.now(),
          replyTo: replyTo ? replyTo.id : null,
          reactions: {}
        };
        try {
          await db.ref(`messages/${currentRoom}/${msgId}`).set(newMsg);
          addDebugLog(`Message sent: "${message.trim().substring(0, 30)}..."`, 'success');
          setMessage('');
          setReplyTo(null);
          db.ref(`typing/${currentRoom}/${username}`).remove();
        } catch (err) {
          setError('Failed to send message');
          addDebugLog(`Message send error: ${err.message}`, 'error');
        }
      };

      const addReaction = async (messageId, emoji) => {
        if (!currentRoom || !db) return;
        try {
          const reactionPath = `messages/${currentRoom}/${messageId}/reactions/${emoji}`;
          const reactionRef = db.ref(reactionPath);
          const snapshot = await reactionRef.once('value');
          const users = snapshot.val() || [];
          if (users.includes(username)) {
            const newUsers = users.filter(u => u !== username);
            if (newUsers.length === 0) {
              await reactionRef.remove();
            } else {
              await reactionRef.set(newUsers);
            }
            addDebugLog(`Removed reaction ${emoji}`, 'info');
          } else {
            await reactionRef.set([...users, username]);
            addDebugLog(`Added reaction ${emoji}`, 'success');
          }
        } catch (err) {
          addDebugLog(`Reaction error: ${err.message}`, 'error');
        }
      };

      const clearAllMessages = async () => {
        const currentRoomData = rooms.find(r => r.id === currentRoom);
        if (!currentRoomData || currentRoomData.owner !== username) {
          alert('‚ùå Only the room owner can clear messages!');
          addDebugLog('Clear messages denied: not owner', 'warning');
          return;
        }
        if (!confirm('‚ö†Ô∏è Clear all messages in this room?')) return;
        try {
          await db.ref(`messages/${currentRoom}`).remove();
          addDebugLog('All messages cleared', 'success');
        } catch (err) {
          setError('Failed to clear messages');
          addDebugLog(`Clear messages error: ${err.message}`, 'error');
        }
      };

      const kickUser = async (targetUser) => {
        const currentRoomData = rooms.find(r => r.id === currentRoom);
        if (!currentRoomData || currentRoomData.owner !== username) {
          alert('‚ùå Only the room owner can kick users!');
          addDebugLog('Kick denied: not owner', 'warning');
          return;
        }
        if (!confirm(`‚ö†Ô∏è Kick ${targetUser} from the room?`)) return;
        const msgId = Date.now().toString() + Math.random().toString(36).substr(2, 9);
        const systemMsg = {
          id: msgId,
          type: 'system',
          text: `${targetUser} was kicked from the room`,
          timestamp: Date.now()
        };
        try {
          await db.ref(`messages/${currentRoom}/${msgId}`).set(systemMsg);
          await db.ref(`roomUsers/${currentRoom}/${targetUser}`).remove();
          addDebugLog(`Kicked user: ${targetUser}`, 'success');
        } catch (err) {
          setError('Failed to kick user');
          addDebugLog(`Kick error: ${err.message}`, 'error');
        }
      };

      const leaveRoom = async () => {
        if (!currentRoom || !username) return;
        const msgId = Date.now().toString() + Math.random().toString(36).substr(2, 9);
        const systemMsg = {
          id: msgId,
          type: 'system',
          text: `${username} left the room`,
          timestamp: Date.now()
        };
        try {
          await db.ref(`messages/${currentRoom}/${msgId}`).set(systemMsg);
          await db.ref(`roomUsers/${currentRoom}/${username}`).remove();
          addDebugLog('Left room', 'info');
        } catch (err) {
          addDebugLog(`Leave room error: ${err.message}`, 'error');
        }
        setCurrentRoom(null);
        setCurrentView('lobby');
        setMessages([]);
      };

      const deleteRoom = async (roomId, e) => {
        e.stopPropagation();
        const room = rooms.find(r => r.id === roomId);
        if (room && room.owner !== username) {
          alert('‚ùå Only the room owner can delete this room!');
          addDebugLog('Delete denied: not owner', 'warning');
          return;
        }
        if (!confirm('‚ö†Ô∏è Delete this room and all messages?')) return;
        try {
          await db.ref(`rooms/${roomId}`).remove();
          await db.ref(`messages/${roomId}`).remove();
          await db.ref(`roomUsers/${roomId}`).remove();
          await db.ref(`typing/${roomId}`).remove();
          addDebugLog(`Room deleted: ${room.name}`, 'success');
        } catch (err) {
          setError('Failed to delete room');
          addDebugLog(`Delete room error: ${err.message}`, 'error');
        }
      };

      const formatTime = (timestamp) => {
        const date = new Date(timestamp);
        return date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
      };

      const getReplyMessage = (replyToId) => {
        return messages.find(m => m.id === replyToId);
      };

      if (currentView === 'start') {
        return (
          <>
            <div style={{ minHeight: '100vh', display: 'flex', alignItems: 'center', justifyContent: 'center', padding: '20px' }}>
              <div className="glow-border" style={{ background: '#0a0a0a', borderRadius: '20px', padding: '40px', width: '100%', maxWidth: '400px', border: '1px solid #333' }}>
                <div style={{ textAlign: 'center', marginBottom: '30px' }}>
                  <div className="glow" style={{ display: 'inline-block' }}><MessageCircle /></div>
                  <h1 className="glow-text" style={{ fontSize: '32px', fontWeight: 'bold', marginTop: '20px', marginBottom: '10px' }}>CHATROOMS</h1>
                  <p style={{ color: '#999' }}>Enter the void</p>
                </div>
                <input
                  type="text"
                  value={tempUsername}
                  onChange={(e) => setTempUsername(e.target.value)}
                  onKeyDown={(e) => e.key === 'Enter' && tempUsername.trim() && (setUsername(tempUsername.trim()), setCurrentView('lobby'))}
                  placeholder="Choose username..."
                  style={{ width: '100%', padding: '15px', background: '#1a1a1a', border: '1px solid #333', borderRadius: '10px', color: '#fff', fontSize: '16px', marginBottom: '20px' }}
                />
                <div style={{ display: 'grid', gap: '10px' }}>
                  <button onClick={() => tempUsername.trim() ? (setUsername(tempUsername.trim()), setCurrentView('lobby')) : setError('Enter a username')} className="glow-button" style={{ width: '100%', background: '#fff', color: '#000', padding: '15px', borderRadius: '10px', border: 'none', fontSize: '16px', fontWeight: 'bold', cursor: 'pointer' }}>JOIN ROOM</button>
                  <button onClick={() => tempUsername.trim() ? (setUsername(tempUsername.trim()), setCurrentView('create')) : setError('Enter a username')} className="glow-button" style={{ width: '100%', background: '#1a1a1a', color: '#fff', padding: '15px', borderRadius: '10px', border: '1px solid #333', fontSize: '16px', fontWeight: 'bold', cursor: 'pointer' }}>CREATE ROOM</button>
                </div>
                {error && <div style={{ background: '#2a0000', border: '1px solid #ff0000', color: '#ff6666', padding: '15px', borderRadius: '10px', marginTop: '15px' }}>{error}</div>}
              </div>
            </div>
            {!showDebug && (
              <div className="debug-toggle" onClick={() => setShowDebug(true)}>
                <Bug />
              </div>
            )}
            {showDebug && <DebugConsole logs={logs} onClose={() => setShowDebug(false)} />}
          </>
        );
      }

      if (currentView === 'create') {
        return (
          <>
            <div style={{ minHeight: '100vh', display: 'flex', alignItems: 'center', justifyContent: 'center', padding: '20px' }}>
              <div className="glow-border" style={{ background: '#0a0a0a', borderRadius: '20px', padding: '40px', width: '100%', maxWidth: '500px', border: '1px solid #333' }}>
                <div style={{ textAlign: 'center', marginBottom: '30px' }}>
                  <div className="glow" style={{ display: 'inline-block' }}><Plus /></div>
                  <h1 className="glow-text" style={{ fontSize: '28px', fontWeight: 'bold', marginTop: '20px', marginBottom: '10px' }}>CREATE ROOM</h1>
                  <p style={{ color: '#999' }}>User: {username}</p>
                </div>
                <input type="text" value={newRoomName} onChange={(e) => setNewRoomName(e.target.value)} placeholder="Room name..." style={{ width: '100%', padding: '15px', background: '#1a1a1a', border: '1px solid #333', borderRadius: '10px', color: '#fff', fontSize: '16px', marginBottom: '15px' }} />
                <input type="password" value={newRoomPassword} onChange={(e) => setNewRoomPassword(e.target.value)} placeholder="Password (optional)..." style={{ width: '100%', padding: '15px', background: '#1a1a1a', border: '1px solid #333', borderRadius: '10px', color: '#fff', fontSize: '16px', marginBottom: '20px' }} />
                <div style={{ display: 'grid', gap: '10px' }}>
                  <button onClick={createRoom} className="glow-button" style={{ width: '100%', background: '#fff', color: '#000', padding: '15px', borderRadius: '10px', border: 'none', fontSize: '16px', fontWeight: 'bold', cursor: 'pointer' }}>CREATE & ENTER</button>
                  <button onClick={() => setCurrentView('lobby')} style={{ width: '100%', background: '#1a1a1a', color: '#fff', padding: '15px', borderRadius: '10px', border: '1px solid #333', fontSize: '16px', fontWeight: 'bold', cursor: 'pointer' }}>BACK</button>
                </div>
                {error && <div style={{ background: '#2a0000', border: '1px solid #ff0000', color: '#ff6666', padding: '15px', borderRadius: '10px', marginTop: '15px' }}>{error}</div>}
              </div>
            </div>
            {!showDebug && (
              <div className="debug-toggle" onClick={() => setShowDebug(true)}>
                <Bug />
              </div>
            )}
            {showDebug && <DebugConsole logs={logs} onClose={() => setShowDebug(false)} />}
          </>
        );
      }

      if (currentView === 'lobby') {
        return (
          <>
            <div style={{ minHeight: '100vh', padding: '20px' }}>
              <div style={{ maxWidth: '900px', margin: '0 auto' }}>
                <div className="glow-border" style={{ background: '#0a0a0a', borderRadius: '20px', padding: '30px', marginBottom: '30px', border: '1px solid #333' }}>
                  <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', marginBottom: '20px', flexWrap: 'wrap', gap: '15px' }}>
                    <div>
                      <h1 className="glow-text" style={{ fontSize: '28px', fontWeight: 'bold', marginBottom: '5px' }}>LOBBY</h1>
                      <p style={{ color: '#999' }}>Logged in as {username}</p>
                    </div>
                    <div style={{ display: 'flex', alignItems: 'center', gap: '15px' }}>
                      <div style={{ display: 'flex', alignItems: 'center', gap: '8px', background: '#1a1a1a', padding: '10px 20px', borderRadius: '10px', border: '1px solid #333' }}>
                        <Users />
                        <span>{onlineCount} online</span>
                      </div>
                      <button onClick={() => setCurrentView('create')} className="glow-button" style={{ background: '#fff', color: '#000', padding: '12px 24px', borderRadius: '10px', border: 'none', fontSize: '14px', fontWeight: 'bold', cursor: 'pointer', display: 'flex', alignItems: 'center', gap: '8px' }}>
                        <Plus /> CREATE
                      </button>
                    </div>
                  </div>
                </div>

                <div style={{ display: 'grid', gap: '15px' }}>
                  {rooms.length === 0 ? (
                    <div className="glow-border" style={{ background: '#0a0a0a', borderRadius: '15px', padding: '60px 20px', textAlign: 'center', border: '1px solid #333' }}>
                      <div className="glow" style={{ display: 'inline-block', marginBottom: '15px' }}><MessageCircle /></div>
                      <p style={{ color: '#666', fontSize: '16px' }}>No rooms yet. Create one!</p>
                    </div>
                  ) : (
                    rooms.map(room => (
                      <div key={room.id} onClick={() => {
                        if (room.password) {
                          const pwd = prompt('üîí Enter room password:');
                          if (pwd !== null) joinRoom(room, pwd);
                        } else {
                          joinRoom(room);
                        }
                      }} className="glow-border" style={{ background: '#0a0a0a', borderRadius: '15px', padding: '20px', border: '1px solid #333', cursor: 'pointer', transition: 'all 0.3s', position: 'relative' }}>
                        <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', gap: '15px' }}>
                          <div style={{ flex: 1 }}>
                            <div style={{ display: 'flex', alignItems: 'center', gap: '10px', marginBottom: '8px' }}>
                              <h3 style={{ fontSize: '18px', fontWeight: 'bold' }}>{room.name}</h3>
                              {room.password && <Lock />}
                            </div>
                            <div style={{ display: 'flex', alignItems: 'center', gap: '15px', color: '#666', fontSize: '13px' }}>
                              <span>Owner: {room.owner}</span>
                              <span>‚Ä¢</span>
                              <span>Created {new Date(room.createdAt).toLocaleDateString()}</span>
                            </div>
                          </div>
                          {room.owner === username && (
                            <button onClick={(e) => deleteRoom(room.id, e)} style={{ background: '#2a0000', border: '1px solid #ff0000', color: '#ff6666', padding: '10px', borderRadius: '8px', cursor: 'pointer', display: 'flex', alignItems: 'center', gap: '5px' }}>
                              <Trash /> Delete
                            </button>
                          )}
                        </div>
                      </div>
                    ))
                  )}
                </div>
              </div>
            </div>
            {!showDebug && (
              <div className="debug-toggle" onClick={() => setShowDebug(true)}>
                <Bug />
              </div>
            )}
            {showDebug && <DebugConsole logs={logs} onClose={() => setShowDebug(false)} />}
          </>
        );
      }

      if (currentView === 'room') {
        const currentRoomData = rooms.find(r => r.id === currentRoom);
        const isOwner = currentRoomData && currentRoomData.owner === username;

        return (
          <>
            <div style={{ height: '100vh', display: 'flex', flexDirection: 'column' }}>
              <div className="glow-border" style={{ background: '#0a0a0a', padding: '20px', borderBottom: '1px solid #333' }}>
                <div style={{ maxWidth: '1200px', margin: '0 auto', display: 'flex', alignItems: 'center', justifyContent: 'space-between', flexWrap: 'wrap', gap: '15px' }}>
                  <div>
                    <h2 className="glow-text" style={{ fontSize: '24px', fontWeight: 'bold', marginBottom: '5px' }}>
                      {currentRoomData?.name || 'Room'}
                    </h2>
                    <div style={{ display: 'flex', alignItems: 'center', gap: '10px', color: '#999', fontSize: '13px' }}>
                      <span>{roomUsers.length} {roomUsers.length === 1 ? 'user' : 'users'} in room</span>
                      {isOwner && <span style={{ background: '#1a1a1a', padding: '4px 10px', borderRadius: '6px', border: '1px solid #333' }}>üëë Owner</span>}
                    </div>
                  </div>
                  <div style={{ display: 'flex', gap: '10px' }}>
                    {isOwner && (
                      <button onClick={clearAllMessages} style={{ background: '#2a0000', border: '1px solid #ff0000', color: '#ff6666', padding: '10px 20px', borderRadius: '8px', cursor: 'pointer', fontSize: '14px', fontWeight: 'bold', display: 'flex', alignItems: 'center', gap: '8px' }}>
                        <Trash /> Clear All
                      </button>
                    )}
                    <button onClick={leaveRoom} className="glow-button" style={{ background: '#1a1a1a', color: '#fff', padding: '10px 20px', borderRadius: '8px', border: '1px solid #333', fontSize: '14px', fontWeight: 'bold', cursor: 'pointer', display: 'flex', alignItems: 'center', gap: '8px' }}>
                      <LogOut /> Leave
                    </button>
                  </div>
                </div>
              </div>

              {roomUsers.length > 1 && (
                <div style={{ background: '#0a0a0a', padding: '10px 20px', borderBottom: '1px solid #333' }}>
                  <div style={{ maxWidth: '1200px', margin: '0 auto', display: 'flex', alignItems: 'center', gap: '10px', flexWrap: 'wrap' }}>
                    <Users style={{ width: '16px', height: '16px' }} />
                    <div style={{ display: 'flex', gap: '8px', flexWrap: 'wrap' }}>
                      {roomUsers.map(user => (
                        <div key={user} style={{ background: '#1a1a1a', padding: '6px 12px', borderRadius: '8px', border: '1px solid #333', fontSize: '13px', display: 'flex', alignItems: 'center', gap: '8px' }}>
                          <span>{user}</span>
                          {user === currentRoomData?.owner && <span>üëë</span>}
                          {isOwner && user !== username && (
                            <button onClick={() => kickUser(user)} style={{ background: 'transparent', border: 'none', color: '#ff6666', cursor: 'pointer', padding: '0 5px' }}>
                              <UserX style={{ width: '14px', height: '14px' }} />
                            </button>
                          )}
                        </div>
                      ))}
                    </div>
                  </div>
                </div>
              )}

              <div style={{ flex: 1, overflow: 'auto', background: '#000', padding: '20px' }}>
                <div style={{ maxWidth: '1200px', margin: '0 auto' }}>
                  {messages.map((msg) => {
                    // Inside the messages.map, after line 680, replace the message rendering section with:
if (msg.type === 'system') {
  return <div key={msg.id} className="system-message">{msg.text}</div>;
}

if (msg.type === 'snap') {
  const userColor = `hsl(${msg.username.split('').reduce((acc, char) => acc + char.charCodeAt(0), 0) % 360}, 70%, 60%)`;
  return (
    <div key={msg.id} className="message-bubble" style={{ marginBottom: '15px', background: msg.username === username ? '#1a1a1a' : '#0a0a0a', padding: '15px', borderRadius: '15px', border: '1px solid #333' }}>
      <div style={{ display: 'flex', alignItems: 'baseline', gap: '10px', marginBottom: '8px' }}>
        <span style={{ color: userColor, fontWeight: 'bold', fontSize: '14px' }}>{msg.username}</span>
        <span style={{ color: '#666', fontSize: '12px' }}>{formatTime(msg.timestamp)} üì∏</span>
      </div>
      <img src={msg.image} alt="Snap" style={{ maxWidth: '100%', borderRadius: '10px', marginTop: '10px' }} />
      {msg.reactions && Object.keys(msg.reactions).length > 0 && (
        <div className="reaction-container">
          {Object.entries(msg.reactions).map(([emoji, users]) => (
            <div key={emoji} onClick={() => addReaction(msg.id, emoji)} className={`reaction ${users.includes(username) ? 'active' : ''}`}>
              <span>{emoji}</span>
              <span>{users.length}</span>
            </div>
          ))}
        </div>
      )}
    </div>
  );
}

                    const replyMsg = msg.replyTo ? getReplyMessage(msg.replyTo) : null;
                    const userColor = `hsl(${msg.username.split('').reduce((acc, char) => acc + char.charCodeAt(0), 0) % 360}, 70%, 60%)`;

                    return (
                      <div key={msg.id} className="message-bubble" style={{ marginBottom: '15px', background: msg.username === username ? '#1a1a1a' : '#0a0a0a', padding: '15px', borderRadius: '15px', border: '1px solid #333' }}>
                        <div className="message-actions">
                          <button onClick={() => setReplyTo(msg)} className="action-btn">Reply</button>
                          <button onClick={() => setShowEmojiPicker(showEmojiPicker === msg.id ? null : msg.id)} className="action-btn">
                            <Smile />
                          </button>
                        </div>

                        {showEmojiPicker === msg.id && (
                          <div className="emoji-picker">
                            {EMOJIS.map(emoji => (
                              <button key={emoji} onClick={() => {
                                addReaction(msg.id, emoji);
                                setShowEmojiPicker(null);
                              }} className="emoji-btn">
                                {emoji}
                              </button>
                            ))}
                          </div>
                        )}

                        <div style={{ display: 'flex', alignItems: 'baseline', gap: '10px', marginBottom: '8px' }}>
                          <span style={{ color: userColor, fontWeight: 'bold', fontSize: '14px' }}>{msg.username}</span>
                          <span style={{ color: '#666', fontSize: '12px' }}>{formatTime(msg.timestamp)}</span>
                        </div>

                        {replyMsg && (
                          <div className="reply-to" style={{ borderColor: userColor }}>
                            <div style={{ fontSize: '11px', color: '#999', marginBottom: '4px' }}>Replying to {replyMsg.username}</div>
                            <div style={{ fontSize: '12px', opacity: 0.7 }}>{replyMsg.text.substring(0, 50)}{replyMsg.text.length > 50 ? '...' : ''}</div>
                          </div>
                        )}

                        <div style={{ fontSize: '15px', lineHeight: '1.5', wordBreak: 'break-word' }}>{msg.text}</div>

                        {msg.reactions && Object.keys(msg.reactions).length > 0 && (
                          <div className="reaction-container">
                            {Object.entries(msg.reactions).map(([emoji, users]) => (
                              <div key={emoji} onClick={() => addReaction(msg.id, emoji)} className={`reaction ${users.includes(username) ? 'active' : ''}`}>
                                <span>{emoji}</span>
                                <span>{users.length}</span>
                              </div>
                            ))}
                          </div>
                        )}
                      </div>
                    );
                  })}

                  {typingUsers.length > 0 && (
                    <div className="typing-indicator">
                      {typingUsers.join(', ')} {typingUsers.length === 1 ? 'is' : 'are'} typing...
                    </div>
                  )}

                  <div ref={messagesEndRef} />
                </div>
              </div>

              <div className="glow-border" style={{ background: '#0a0a0a', padding: '20px', borderTop: '1px solid #333' }}>
                <div style={{ maxWidth: '1200px', margin: '0 auto' }}>
                  {replyTo && (
                    <div className="reply-preview">
                      <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'start', marginBottom: '5px' }}>
                        <span style={{ fontSize: '12px', color: '#999' }}>Replying to {replyTo.username}</span>
                        <button onClick={() => setReplyTo(null)} style={{ background: 'transparent', border: 'none', color: '#666', cursor: 'pointer', fontSize: '18px', lineHeight: 1 }}>√ó</button>
                      </div>
                      <div style={{ fontSize: '13px', opacity: 0.8 }}>{replyTo.text.substring(0, 80)}{replyTo.text.length > 80 ? '...' : ''}</div>
                    </div>
                  )}

{showCamera && (
  <div style={{ marginBottom: '15px', background: '#1a1a1a', padding: '20px', borderRadius: '15px', border: '1px solid #333' }}>
    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '15px' }}>
      <h3 style={{ fontSize: '16px', fontWeight: 'bold' }}>üì∏ Take a Snap</h3>
      <button onClick={stopCamera} style={{ background: 'transparent', border: 'none', color: '#999', cursor: 'pointer', fontSize: '24px' }}>√ó</button>
    </div>
    <video ref={videoRef} autoPlay playsInline style={{ width: '100%', borderRadius: '10px', marginBottom: '15px' }} />
    <canvas ref={canvasRef} style={{ display: 'none' }} />
    <button onClick={takeSnap} className="glow-button" style={{ width: '100%', background: '#fff', color: '#000', padding: '15px', borderRadius: '10px', border: 'none', fontSize: '16px', fontWeight: 'bold', cursor: 'pointer' }}>
      üì∏ SNAP & SEND
    </button>
  </div>
)}

                  <div style={{ display: 'flex', gap: '10px' }}>
                    <input
                      type="text"
                      value={message}
                      onChange={(e) => {
                        setMessage(e.target.value);
                        updateTyping();
                      }}
                      onKeyDown={(e) => e.key === 'Enter' && sendMessage()}
                      placeholder="Type a message..."
                      style={{ flex: 1, padding: '15px', background: '#1a1a1a', border: '1px solid #333', borderRadius: '10px', color: '#fff', fontSize: '15px' }}
                    />
                    <button onClick={sendMessage} className="glow-button" style={{ background: '#fff', color: '#000', padding: '15px 30px', borderRadius: '10px', border: 'none', fontSize: '16px', fontWeight: 'bold', cursor: 'pointer', display: 'flex', alignItems: 'center', gap: '8px' }}>
  <Send /> Send
</button>

<button onClick={startCamera} className="glow-button" style={{ background: '#1a1a1a', color: '#fff', padding: '15px 30px', borderRadius: '10px', border: '1px solid #333', fontSize: '16px', fontWeight: 'bold', cursor: 'pointer' }}>
  üì∏
</button>
</div>
                </div>
              </div>
            </div>
            {!showDebug && (
              <div className="debug-toggle" onClick={() => setShowDebug(true)}>
                <Bug />
              </div>
            )}
            {showDebug && <DebugConsole logs={logs} onClose={() => setShowDebug(false)} />}
          </>
        );
      }

      return null;
    }

    ReactDOM.render(<ChatroomApp />, document.getElementById('root'));
  </script>
<script>
  // Redirect to about:blank to hide from history
  if (window.location.href !== 'about:blank') {
    const newWindow = window.open('about:blank', '_blank');
    if (newWindow) {
      newWindow.document.write(document.documentElement.outerHTML);
      newWindow.document.close();
      window.close();
    }
  }
</script>
</body>
</html>
